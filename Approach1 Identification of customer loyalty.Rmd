---
title: "Approach 1-Identification of customer loyalty - exploratory approach"
output: word_document
---

```{r}
rm(list = ls())
library(dplyr)
library(data.table)
library(tidyr)
library(ggplot2)
library(forecast)
library(plotly)
library(corrplot)
library(lme4)


# required functions
man_mode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}


#setwd("")
cp <- fread('/Users/chenlu/Desktop/cleaned_data.csv', stringsAsFactors = FALSE)
cp$Date_time <- as.POSIXct(cp$Date_time, "%Y-%m-%d %H:%M:%S", tz=Sys.timezone())

cp <- cp %>% mutate(month = format(Date_time, '%b'),
                    day = format(Date_time, '%a'),
                    hour = format(Date_time, '%H'),
                    price = Gross.Sales / Qty,
                    ym = format(Date_time, '%Y-%m'))
```


### Approach 1: Identification of customer loyalty - exploratory approach

#### Description and rationale for the analysis:
As a first step, we want to validate whether loyalty among Central Perk customers exists as claimed by the business. Identification of loyal customers would help us in providing them with incentives for better customer experience while helping us in devising a strategy to make more customers follow that pattern. In case of absence of loyal customers, we would like the store management to be aware of this issue and dig more into the reasons for customer dissatisfaction or any other causes leading to customer churn. The crudest way to observe loyalty would be to understand if a small chunk of customers is driving significant amount of sales - Pareto's principle. However, we would like to perform thorough checks to support our findings.

__Key Goal__: Identify whether a loyal customer base exists for Central Perk


The first step to identify loyalty among customers is to determine the share of sales generated through repeating customers. Based on Pareto's 80-20 rule, we expect majority share of the sales to be driven by a small proportion of the customers who pay repeated visits to our store. Keeping only the customer data that has a customer id associated to it and then determining various customer metrics such as lifetime purchase and tenure (day of last transaction - day of first transaction) of the customer

``` {r}
loyalty <- cp %>% filter(!is.na(Customer.ID)) %>% group_by(Customer.ID) %>% 
  summarise(first_purchase = min(Date_time),
            last_purchase = max(Date_time),
            distinct_trans = n_distinct(Date_time),
            lifetime_net = sum(Net.Sales),
            lifetime_purs = sum(Qty)) %>% 
  mutate(tenure = as.Date(last_purchase,  '%Y-%m-%d')  - as.Date(first_purchase, '%Y-%m-%d'),
         avg_trans = lifetime_net / distinct_trans)
```

Initially we will check the share of sales by customers for those customers who have:

1.	A customer ID
2.	Visited more than once

as compared to the overall sales across 3 years:


``` {r}
print(paste('The % share of registered customers that have visited more than once is: ',
      round(nrow(loyalty[which(loyalty$tenure > 0),]) / nrow(loyalty) * 100, 2)))

print(paste('The % share of net sales by just 22% of registered customers is: ',
            round(sum(loyalty[which(loyalty$tenure > 0), 'lifetime_net']) / sum(cp$Net.Sales) * 100, 2)))
```

About 43% of net sales over 3 years are being driven by just 22% of registered customers who have visited more than once


``` {r}
loyalty <- data.frame(loyalty)
print(paste('The % share of total transactions driven by 22% of registered customers is: ',
            round(nrow(cp[which(cp$Customer.ID %in% loyalty[which(loyalty$tenure > 0), 'Customer.ID']),]) / nrow(cp) * 100, 2)))
```

Hence, we can conclude that a large number of transactions and sales are being generated by a small number of customers by which we can safely assume presence of loyal customers.
Looking at the distribution of tenure of the customers

``` {r}
loyalty <- filter(loyalty, tenure > 0)
# Looking at the distribution of tenure of the customers
ggplot(loyalty, aes(x = tenure)) +
  geom_histogram(binwidth = 5, color = 'yellow', fill = 'darkred') +
  ggtitle('Distribution of customers based on tenure') + xlab('Tenure') + ylab('No. of customers')
```

We can observe that a significant portion of the customers have tenure greater than about a month (30 days).

Looking at the cumulative sales share based on share of customers visiting more than once:

``` {r}
loyalty <- loyalty %>% arrange(-lifetime_net) %>% 
  mutate(cumshare = 100 * cumsum(lifetime_net) / sum(cp$Net.Sales))

ggplot(loyalty, aes(x = seq(1, nrow(loyalty)), y = cumshare)) +
  geom_line(size = 1, color = 'steelblue')+
  ggtitle('Cumulative sales share by revsiting customers') + xlab('Customers') + ylab('Share of total sales')
```

Hence based on the saturation of the curve we can deduce that Central Perk has a loyal customer base of about 4K customers.
Finally, we would like to see trends in tenure vs transactions.


``` {r}
ggplot(loyalty[which(loyalty$distinct_trans <= 100), ], aes(x = tenure, y = distinct_trans)) +
  geom_point(alpha = 0.5, color = 'yellow', fill = 'darkred', pch = 21) +
  geom_smooth(formula = y ~ x, method = 'lm', se = TRUE)+
  ggtitle('Distribution of days visited against tenure') + xlab('Tenure') + ylab('Days visited')
```

The general pattern of visits against tenure shows increasing pattern which indicates that loyal customers tend to visit repeatedly over time

``` {r}
loyalty$trans_pd <- as.numeric(loyalty$tenure) / loyalty$distinct_trans
ggplot(loyalty, aes(x = trans_pd)) +
  geom_histogram(fill = 'darkred', color = 'yellow')+
  ggtitle('Distribution of average number of days beteen visits') +
  xlab('Average days between visits') + ylab('No. of customers')
```

From here, it can be concluded that a high number of loyal customers have up to 50 days of gap between subsequent visits. Hence, we have decent chunk of loyal customers
Customers can churn over period, but we want to ensure that our customer base consistently has certain portion of loyal customer base retained hence we would like to check overall population of the loyal customers over time, In order to get this metric, we will check number of repeating customers month on month

``` {r, include = FALSE}
# For additional insights we can check the change in average spends per transaction based on tenure
ggplot(loyalty, aes(x = tenure, y = avg_trans)) +
  geom_point(alpha = 0.5, color = 'yellow', fill = 'darkred', pch = 21) +
  geom_smooth(formula = y ~ x, method = 'lm', se = TRUE)+
  ggtitle('Average spends based on tenure') + xlab('Tenure') + ylab('Average spends per transaction')
```

``` {r}
mom <- cp %>% group_by(Customer.ID) %>% summarise(ym = min(ym))
mom <- na.omit(mom)
mom_trend <- unique(cp[, c('ym', 'Customer.ID')])
mom_trend <- na.omit(mom_trend)
mom$cust <- 'new'
mom_trend <- merge(mom_trend, mom, all.x = TRUE)
mom_trend[which(is.na(mom_trend$cust)), 'cust'] <- 'old'
mom_trend <- mom_trend %>% group_by(ym, cust) %>% summarise(count = n())
ggplot(mom_trend, aes(x = ym, y = count, group = cust, color = cust)) +
  geom_line(size = 1.5) +
  ggtitle('New vs revisiting customers over time') + xlab('Year-Month') + ylab('No. of customers') +
  theme(axis.text.x = element_text(angle = 90, hjust = 1))
```

Here we can ignore the dip in last month since the data is incomplete, but we can observe that overall repeating customers stay constant and even show a slight increasing trend even though the number of new customers fluctuates, hence we can say that Central Perk has a constant moving customer base with loyalty over specific time period keeping the overall number of repeating/loyal customers constant
Hence, we can safely assume that loyalty among customers exists. Further insights about the loyal customers can be found out through clustering

#### Inference and conclusions:

1.	Central Perk has a significant loyal customer base that contributes to about 43% of the overall sales
2.	The loyal customer base is moving - keeps changing over the years with customers spanning from 2 months to 8 months of tenure, however overall number of loyal customers stays relatively flat
3.	This means that even though some of the older customers are churning out, new customers are being converted to loyal customers in similar rate
4.	The customers with high tenure are also having a greater number of visits i.e. it the case of a customer visiting only twice in 2.5 years is less likely

#### Next approach based on the above conclusions:

1.	Since we have established the presence of loyal customers, we would like to understand the attributes that define these customers
2.	Being cognizant about characteristics and purchase behavior of the loyal customers will help us in providing recommendations to lift the sales in relevant timeframes

